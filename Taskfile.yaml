# https://taskfile.dev

version: "3"

vars:
  DOCKER_IMAGE: adrianliechti/loop-code

tasks:
  push:
    run: once
    cmds:
      - docker buildx build --push --platform linux/arm64,linux/amd64 --tag {{.DOCKER_IMAGE}} .

  push-stacks:
    cmds:
      - task: push-stack
        vars: { STACK: "dind" }
      - task: push-stack
        vars: { STACK: "golang" }

  run-stack:
    cmds:
      - docker run -i --rm --pull=always -p 3000:3000 {{.DOCKER_IMAGE}}:{{.STACK}}

  push-stack:
    deps:
      - push
    cmds:
      - docker buildx build --push --platform linux/arm64,linux/amd64 --tag {{.DOCKER_IMAGE}}:{{.STACK}} stacks/{{.STACK}}/ -f stacks/{{.STACK}}/Dockerfile

  install:
    cmds:
      - kubectl create ns loop -o yaml --dry-run=client | kubectl apply -f -
      - kubectl apply -f kubernetes/*

  uninstall:
    cmds:
      - kubectl delete -f kubernetes/*
